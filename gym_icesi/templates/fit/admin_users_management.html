{% extends 'base.html' %}
{% block title %}Gesti√≥n de Usuarios - Gym Icesi{% endblock %}

{% block content %}
<div style="margin-bottom:1.5rem;">
  <a href="{% url 'home' %}" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
</div>

<div style="margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:2px solid #e5e7eb;">
  <h1 style="margin:0 0 0.5rem 0;">üë• Gesti√≥n de Usuarios</h1>
  <p style="color:#6b7280;margin:0;">Panel completo de administraci√≥n de usuarios del sistema</p>
</div>

<!-- Filtros Avanzados -->
<div class="card" style="margin-bottom:1.5rem;">
  <h3 style="margin:0 0 1rem 0;">üîç Filtros de B√∫squeda</h3>
  <form method="get" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:1rem;">
    <div>
      <label for="q" style="display:block;margin-bottom:0.5rem;font-weight:500;">Buscar Usuario</label>
      <input type="text" name="q" id="q" value="{{ search_query }}" class="form-control" placeholder="Nombre de usuario...">
    </div>
    
    <div>
      <label for="role" style="display:block;margin-bottom:0.5rem;font-weight:500;">Rol</label>
      <select name="role" id="role" class="form-control">
        <option value="">Todos</option>
        <option value="student" {% if role_filter == "student" %}selected{% endif %}>Estudiante</option>
        <option value="employee" {% if role_filter == "employee" %}selected{% endif %}>Empleado</option>
        <option value="trainer" {% if role_filter == "trainer" %}selected{% endif %}>Entrenador</option>
      </select>
    </div>
    
    <div>
      <label for="campus" style="display:block;margin-bottom:0.5rem;font-weight:500;">Campus</label>
      <select name="campus" id="campus" class="form-control">
        <option value="">Todos</option>
        {% for campus in campuses %}
          <option value="{{ campus }}" {% if campus_filter == campus %}selected{% endif %}>{{ campus }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div>
      <label for="activity" style="display:block;margin-bottom:0.5rem;font-weight:500;">Nivel de Actividad</label>
      <select name="activity" id="activity" class="form-control">
        <option value="">Todos</option>
        <option value="high" {% if activity_filter == "high" %}selected{% endif %}>Alta (10+ sesiones/mes)</option>
        <option value="medium" {% if activity_filter == "medium" %}selected{% endif %}>Media (5-9 sesiones/mes)</option>
        <option value="low" {% if activity_filter == "low" %}selected{% endif %}>Baja (1-4 sesiones/mes)</option>
        <option value="inactive" {% if activity_filter == "inactive" %}selected{% endif %}>Inactivo (0 sesiones)</option>
      </select>
    </div>
    
    <div style="display:flex;align-items:end;gap:0.5rem;">
      <button type="submit" class="btn btn-primary" style="flex:1;">üîç Buscar</button>
      <a href="{% url 'admin_users_management' %}" class="btn btn-secondary">Limpiar</a>
    </div>
  </form>
</div>

<!-- Lista de Usuarios -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
    <h3 style="margin:0;">üìã Usuarios del Sistema ({{ users|length }})</h3>
  </div>
  
  {% if users %}
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb;">
            <th style="padding:0.75rem;text-align:left;font-weight:600;color:#111827;">Usuario</th>
            <th style="padding:0.75rem;text-align:left;font-weight:600;color:#111827;">Rol</th>
            <th style="padding:0.75rem;text-align:left;font-weight:600;color:#111827;">Campus</th>
            <th style="padding:0.75rem;text-align:center;font-weight:600;color:#111827;">Sesiones</th>
            <th style="padding:0.75rem;text-align:center;font-weight:600;color:#111827;">Rutinas</th>
            <th style="padding:0.75rem;text-align:center;font-weight:600;color:#111827;">Entrenador</th>
            <th style="padding:0.75rem;text-align:center;font-weight:600;color:#111827;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in users %}
            <tr style="border-bottom:1px solid #e5e7eb;">
              <td style="padding:0.75rem;">
                <strong style="color:#111827;">{{ item.user.username }}</strong>
                <div style="color:#6b7280;font-size:0.85rem;">
                  {{ item.info.first_name|default:"" }} {{ item.info.last_name|default:"" }}
                </div>
              </td>
              <td style="padding:0.75rem;">
                {% if item.user.is_staff %}
                  <span class="badge" style="background:#dbeafe;color:#1e40af;">Entrenador</span>
                {% elif item.info.role == "STUDENT" %}
                  <span class="badge" style="background:#d1fae5;color:#065f46;">Estudiante</span>
                {% elif item.info.role == "EMPLOYEE" %}
                  <span class="badge" style="background:#fef3c7;color:#92400e;">Empleado</span>
                {% else %}
                  <span class="badge" style="background:#e5e7eb;color:#6b7280;">Usuario</span>
                {% endif %}
              </td>
              <td style="padding:0.75rem;color:#6b7280;">
                {{ item.info.campus|default:"-" }}
              </td>
              <td style="padding:0.75rem;text-align:center;color:#111827;">
                {{ item.total_sesiones }}
              </td>
              <td style="padding:0.75rem;text-align:center;color:#111827;">
                {{ item.rutinas_count }}
              </td>
              <td style="padding:0.75rem;text-align:center;">
                {% if item.tiene_entrenador %}
                  <span class="badge badge-success">‚úì</span>
                {% else %}
                  <span class="badge" style="background:#fee2e2;color:#991b1b;">‚úó</span>
                {% endif %}
              </td>
              <td style="padding:0.75rem;text-align:center;">
                <a href="{% url 'admin_assign_trainer_advanced' %}#user-{{ item.user.id }}" class="btn btn-sm">üë• Asignar</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty-state">
      <p>No se encontraron usuarios con los filtros aplicados.</p>
    </div>
  {% endif %}
</div>
{% endblock %}

